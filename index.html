<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Flappy Module 1</title>
    <style>
        *{
            box-sizing: border-box;
            padding:0px;
        }
        .MainBox {
            line-height: 0;
            width:800px;
            height:600px;
            margin: 0 auto;
            background-color: black;
        }
         canvas{
            height:600px;
            width:800px;
            position: absolute;
        }
        #Mainlayer{
            z-index: 1;
        } 
        #BackgroundLayer{
            z-index: 0;
        } 
    </style>
</head>
<body>
    <div class="MainBox">
        <canvas id="Mainlayer"></canvas>
        <canvas id="BackgroundLayer" width = "800" height = "600"></canvas>
        <canvas id="ArrowLayer"></canvas>
    </div>
    <script src="background.js"></script>
    <!-- <script src="Object.js"></script> -->
    
    <script>
    let isStarted=false;
    let isDead=false;
    let background = document.getElementById('BackgroundLayer');  
    let Mainlayer = document.getElementById('Mainlayer'); 
    let ctxMain = Mainlayer.getContext('2d'); 
    let ArrowLayer = document.getElementById('ArrowLayer'); 
    let ctxArrow = ArrowLayer.getContext('2d'); 
    let score=0;
    let HighScore;
    if(HighScore==null&&window.localStorage.getItem('highScore')!=null){
        HighScore=window.localStorage.getItem('highScore');
    }
    if(window.localStorage.getItem('highScore')==null){
        HighScore=0;
        window.localStorage.setItem('highScore', JSON.stringify(HighScore));
        console.log("highscore set =0")
    }


    const droppingSpeed= 1;
    const BgSpeed=4;
    const ScreenHeight=600;
    const ScreenWidth=800;
    const BirdStartX=50;
    const BirdStartY=80;
    const JumpHeight=30;
    const TopBoundaryY=-5;
    const GroundLevel=110;
    const ArrowRestartX=290;
    const CoinRestartX=290;
    const ScoreX=130;
    const ScoreY=140;
    const ArrowAfterSpaceX=-20;
    const PressSpaceToStartTextX=110;
    const PressSpaceToStartTextY=100;
    const HighScoreTextX=110;
    const HighScoreTextY=120;
    const BannerImagePosX=52;
    const BannerImagePosY=10;
    const ArrowOneSpeed=5;
    const ArrowTwoSpeed=6;
    const ArrowThreeSpeed=4;
    const CoinSpeed=2;
    const ArrowOneStartX=-10;
    const ArrowTwoStartX=-90;
    const ArrowThreeStartX=-10;
    const CoinStartX=-120;
    const ArrowOneMinY=0;
    const ArrowOneMaxY=40;
    const ArrowTwoMinY=40;
    const ArrowTwoMaxY=60;
    const ArrowThreeMinY=60;
    const ArrowThreeMaxY=100;
    const CoinMinY=0;
    const CoinMaxY=110;
    const GameOverX=120;
    const GameOverY=55
    const FinalScoreX=120;
    const FinalScoreY=88;
    



    function ImageObj(){
        this.bird=new Image();
        this.Arrow= new Image();
        this.coin=new Image(); 
        this.front=new Image()
        this.bird.src = "bird.png";
        this.Arrow.src = "arrow.png";
        this.coin.src="coin.png";
        this.front.src="Banner.png"
        this.self=this;
    }
    
    ImageObj.prototype.setPositionValue=function(x, y,layer,Dropping){
        this.x = x;
        this.y = y;
        this.layer=layer;
        this.Dropping=Dropping
        this.ToaDo=[this.x,this.y];
    }
    ImageObj.prototype.drop=function(self){
        if(self.y<GroundLevel){
            if(self.Dropping==true){
                self.layer.clearRect(0,0,ScreenWidth,ScreenHeight)
                self.layer.drawImage(self.bird,self.x,self.y+=droppingSpeed)
            }
            else {
                return;
            }
            self.ToaDo=[self.x,self.y];
        }
        if(self.y>=GroundLevel){
            turnToDead();
            return;
        }
        if(isDead==true){
            turnToDead();
            return;
        }
        window.requestAnimationFrame(function() {self.drop(self)})
    }

    ImageObj.prototype.jumpBird=function(self){
        self.layer.clearRect(0, 0, ScreenWidth, ScreenHeight)
        if(self.Dropping==false){
        self.layer.drawImage(self.bird,self.x,self.y-=droppingSpeed)
        self.ToaDo=[self.x,self.y];
        }
        if(self.y<self.ToaDoNhay-JumpHeight){
            self.Dropping=true;
            self.drop(self);
            return;
        }
        if(self.y<TopBoundaryY){
            self.y=TopBoundaryY+1;
            self.Dropping=true;
            self.drop(self);
            return;
        }
        if(isDead==true){
            return;
        }
        window.requestAnimationFrame(function() {self.jumpBird(self)});
    } 
    
    ImageObj.prototype.drawFlyingArrow=function(self,num1,num2,num4,num5){
        self.layer.drawImage(self.Arrow,self.x-=num1,self.y)
        self.ToaDo[0]=self.x;
        self.ToaDo[1]=self.y;
        if(self.x<num2){
            self.x=ArrowRestartX;
            self.y=randomInteger(num4,num5);  
        }
    }

    ImageObj.prototype.drawScore=function(self){
        self.layer.font="10px Tahoma";
        self.layer.fillStyle ="White";
        self.layer.fillText("score "+ score, ScoreX, ScoreY ); 

    }
        ImageObj.prototype.drawFlyingCoin=function(self,num1,num2,num4,num5,chim){
        self.layer.drawImage(self.coin,self.x-=num1,self.y)
        self.ToaDo[0]=self.x;
        self.ToaDo[1]=self.y;
        if(self.x<num2){
            self.x=CoinRestartX;
            self.y=randomInteger(num4,num5);    
        }  
    }


    ImageObj.prototype.StartBanner=function(self){
        self.layer.font="10px Tahoma";
        self.layer.fillStyle ="Black";
        self.layer.fillText("Press Space to Start ", PressSpaceToStartTextX, PressSpaceToStartTextY ); 
        self.layer.fillText("High Score "+window.localStorage.getItem('highScore'), HighScoreTextX, HighScoreTextY ); 
        self.layer.drawImage(self.front,BannerImagePosX,BannerImagePosY);
    }

    ImageObj.prototype.checkArrowCollision=function (arrow,chim){
        if((chim.ToaDo[0]+3>=arrow.ToaDo[0])&&(chim.ToaDo[0]-3<=arrow.ToaDo[0] )&&(chim.ToaDo[1]+2>=arrow.ToaDo[1])&&(chim.ToaDo[1]-4<=arrow.ToaDo[1])){
            if(score>=HighScore){
            HighScore=score;
            window.localStorage.setItem('highScore', JSON.stringify(HighScore));
            }
            turnToDead();
        }
    }

    ImageObj.prototype.checkCoinCollision=function (coin,chim){
    if((chim.ToaDo[0]+3>=coin.ToaDo[0])&&(chim.ToaDo[0]-3<=coin.ToaDo[0] )&&(chim.ToaDo[1]+7>=coin.ToaDo[1])&&(chim.ToaDo[1]-7<=coin.ToaDo[1])){
        score++;
        coin.x=-30;
        console.log(score) 
        return;
        }
    }      
    
    ImageObj.prototype.whenPressSpace=function(self){
        if(isStarted==false){
            bird.setPositionValue(80,50,ctxMain,true);
            isStarted=true;
            ArrowDraw(Arrow,Arrow2,Arrow3,coin,bird,Banner,scoreBoard); 
        }
        self.ToaDoNhay=self.y;
        if(self.Dropping==true){
            self.Dropping=false;
            self.jumpBird(self);
        }   
    } 

    // window.addEventListener("keypress",bwhenPressSpace());
    function randomInteger(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function backgroundClass(width,height,baseImage,scrollSpeed){
    this.background=document.getElementById('BackgroundLayer');
    this.background.width=ScreenWidth;
    this.background.height=ScreenHeight;  
    this.width=width
    this.height=height
    this.img=new Image()
    this.self=this
    this.img.src=baseImage
    this.imgWidth = ScreenWidth;
    this.scrollSpeed=scrollSpeed;
    }

    backgroundClass.prototype.setPositionValueContext= function(){
        this.ctxBack=this.background.getContext('2d'); 
    }

    backgroundClass.prototype.running=function(self){
        self.ctxBack.drawImage(self.img,self.imgWidth, 0); 
        if(self.background .width+self.imgWidth<ScreenWidth){ 
        self.ctxBack.drawImage(self.img,self.background.width+self.imgWidth,0); 
        }
        else {
            self.ctxBack.drawImage(self.img,-(self.background.width-self.imgWidth),0)
        }
        self.imgWidth -= self.scrollSpeed; 
        if (self.imgWidth == -self.background.width){
            self.imgWidth = ScreenWidth; 
        }
        if(isDead==true){
            turnToDead();
            return;
        }
        window.requestAnimationFrame(function() {self.running(self)});
    }
    //////////////////////////////////////////////////////////////////////////////////////////////

    function ArrowDraw(self1,self2,self3,self4,chim,Banner,score){
        self1.layer.clearRect(0, 0, ScreenWidth, ScreenHeight)
        self1.drawFlyingArrow(self1,ArrowOneSpeed,ArrowOneStartX,ArrowOneMinY,ArrowOneMaxY)
        self2.drawFlyingArrow(self2,ArrowTwoSpeed,ArrowTwoStartX,ArrowTwoMinY,ArrowTwoMaxY)  
        self3.drawFlyingArrow(self3,ArrowThreeSpeed,ArrowThreeStartX,ArrowThreeMinY,ArrowThreeMaxY)
        self4.drawFlyingCoin(self4,CoinSpeed,CoinStartX,CoinMinY,CoinMaxY)
        self1.checkArrowCollision(self1,chim);  
        self2.checkArrowCollision(self2,chim);  
        self3.checkArrowCollision(self3,chim);
        self4.checkCoinCollision(self4,chim);
        scoreBoard.drawScore(score);
        if(isDead==true){
            deadScoreBoard(self1);
            return;
        }
        window.requestAnimationFrame(function() {ArrowDraw(self1,self2,self3,self4,chim,Banner,score)});
    }
    
    function WaitScreen(self1,self2,self3,self4,Banner,background){
        Banner.setPositionValue(0,80,ctxArrow,true)
        self1.layer.clearRect(0, 0, ScreenWidth, ScreenHeight)
        self1.drawFlyingArrow(self1,ArrowOneSpeed,ArrowOneStartX,ArrowOneMinY,ArrowOneMaxY)
        self2.drawFlyingArrow(self2,ArrowTwoSpeed,ArrowTwoStartX,ArrowTwoMinY,ArrowTwoMaxY)  
        self3.drawFlyingArrow(self3,ArrowThreeSpeed,ArrowThreeStartX,ArrowThreeMinY,ArrowThreeMaxY)
        self4.drawFlyingCoin(self4,CoinSpeed,CoinStartX,CoinMinY,CoinMaxY)
        Banner.StartBanner(Banner.self);
        if(isStarted==true){
            self1.layer.clearRect(0, 0, ScreenWidth, ScreenHeight)
            self1.x=ArrowAfterSpaceX
            self2.x=ArrowAfterSpaceX
            self3.x=ArrowAfterSpaceX
            self4.x=ArrowAfterSpaceX 
            return;
        }
        window.requestAnimationFrame(function() {WaitScreen(self1,self2,self3,self4,Banner)});
    }
    function turnToDead(){
        isDead=true;
        return 
    }
    function deadScoreBoard(self){
        self.layer.font="13px Tahoma";
        self.layer.fillStyle ="Black";
        self.layer.fillText("GAME OVER!! ", GameOverX, GameOverY ); 
        self.layer.fillText(" SCORE "+score, FinalScoreX, FinalScoreY ); 
        window.addEventListener("keypress",function replay(){
            location.reload()
        });
        return;
    }

    ////////////////////////////////////////////////////////////////////////////////////////// ////////
    
    let Arrow=new ImageObj(); 
    let Arrow2=new ImageObj(); 
    let Arrow3=new ImageObj();
    let Arrow4=new ImageObj();
    let Banner= new ImageObj();
    let coin= new ImageObj();
    let bird= new ImageObj();
    let scoreBoard= new ImageObj();
    let BlueSkyBG=new backgroundClass(ScreenWidth,ScreenHeight,"PixelArt.png",BgSpeed)
    Arrow.setPositionValue(0,0,ctxArrow,true);
    Arrow2.setPositionValue(0,0,ctxArrow,true);
    Arrow3.setPositionValue(0,0,ctxArrow,true);
    Arrow4.setPositionValue(0,0,ctxArrow,true); 
    coin.setPositionValue(0,0,ctxArrow,true);
    scoreBoard.setPositionValue(0,0,ctxArrow,true);
    BlueSkyBG.setPositionValueContext();
    BlueSkyBG.running(BlueSkyBG);
    WaitScreen(Arrow,Arrow2,Arrow3,coin,Banner);
    window.addEventListener("keypress",function() {bird.whenPressSpace(bird)})
    </script>
</body>
</html>
